var locationpath="root";var parentpath="null";var ap;var zipTimer;var folderView;var originFolderView;var fs;var ifs;var checkedMovefiles;var constraintLevel;var account;var isUpLoading=false;var isImporting=false;var isChangingPassword=false;var importFolderName;var xhr;var viewerPageSize=15;var viewer;var viewerPageIndex;var viewerTotal;var pvl;var checkFilesTip="提示：您还未选择任何文件，请先选中一些文件后再执行本操作：<br /><br /><kbd>单击</kbd>：选中某一文件<br /><br /><kbd><kbd>Shift</kbd>+<kbd>单击</kbd></kbd>：选中多个文件<br /><br /><kbd><kbd>Shift</kbd>+<kbd>双击</kbd></kbd>：选中连续的文件<br /><br /><kbd><kbd>Shitf</kbd>+<kbd>A</kbd></kbd>：选中/取消选中所有文件";var winHeight;var pingInt;var noticeInited=false;var loadingComplete;var totalFoldersOffset;var totalFilesOffset;var remainingLoadingRequest;var loadingFolderView;$(function(){window.onresize=function(){changeFilesTableStyle();updateWinHeight()};changeFilesTableStyle();getServerOS();subscribeNotice();var e=document.cookie.match(new RegExp("(^| )folder_id=([^;]*)(;|$)"));if(e!=null){showFolderView(unescape(e[2]))}else{showFolderView("root")}$(document).click(function(e){var t=$("#filetable")[0];var o=e.srcElement;if(!o){o=e.target}if(o!==t&&!$.contains(t,e.target)){$(".filerow").removeClass("info")}});$("#audioPlayerModal").on("hidden.bs.modal",function(e){if(ap!=null){ap.seek(0);ap.pause()}if(pingInt!=null){window.clearInterval(pingInt);pingInt=null}});$("#downloadAllCheckedModal").on("hidden.bs.modal",function(e){if(zipTimer!=null){window.clearInterval(zipTimer)}});$("#loginModal").on("hidden.bs.modal",function(e){$("#accountid").val("");$("#accountpwd").val("");$("#accountidbox").removeClass("has-error");$("#accountpwdbox").removeClass("has-error");$("#alertbox").removeClass("alert");$("#alertbox").removeClass("alert-danger");$("#alertbox").text("");$("#vercodebox").html("");$("#vercodebox").removeClass("show");$("#vercodebox").addClass("hidden")});$(".modal").on("shown.bs.modal",function(e){$(this).addClass("shown")});$(".modal").on("hidden.bs.modal",function(e){$(this).removeClass("shown")});$("body").keypress(function(e){var t=e.keyCode?e.keyCode:e.which?e.which:e.charCode;if(t==13){if("sreachKeyWordIn"===document.activeElement.id){doSearchFile()}else{var o=$(".shown .btn-primary");if(o.get(0)!=null){o.click()}}return false}});$("#loginModal").on("shown.bs.modal",function(e){$("#accountid").focus()});$("#newFolderModal").on("show.bs.modal",function(e){$("#folderalert").removeClass("alert");$("#folderalert").removeClass("alert-danger");$("#foldernamebox").removeClass("has-error");$("#folderalert").text("");$("#foldername").val("");$("#foldertypelist").html("");if(account!=null){$("#foldername").attr("folderConstraintLevel",constraintLevel+"");$("#newfoldertype").text(folderTypes[constraintLevel]);for(var t=constraintLevel;t<folderTypes.length;t++){$("#foldertypelist").append("<li><a onclick='changeNewFolderType("+t+")'>"+folderTypes[t]+"</a></li>")}}else{$("#foldertypelist").append("<li><a onclick='changeNewFolderType(0)'>"+folderTypes[0]+"</a></li>")}});$("#newFolderModal").on("shown.bs.modal",function(e){$("#foldername").focus()});$("#uploadFileModal,#importFolderModal").on("hidden.bs.modal",function(e){if(isUpLoading||isImporting){$("#operationMenuBox").attr("data-placement","top");$("#operationMenuBox").attr("data-trigger","focus");$("#operationMenuBox").attr("data-title","上传中");$("#operationMenuBox").attr("data-content","您可以重新打开上传窗口查看上传进度。");$("#operationMenuBox").popover();$("#operationMenuBox").popover("show");var t=setTimeout(function(){$("#operationMenuBox").attr("data-title","");$("#operationMenuBox").attr("data-content","");$("#operationMenuBox").popover("destroy")},2e3)}});$("#renameFolderModal").on("show.bs.modal",function(e){$("#editfolderalert").removeClass("alert");$("#editfolderalert").removeClass("alert-danger");$("#folderrenamebox").removeClass("has-error");$("#editfolderalert").text("");$("#editfoldertypelist").html("");if(account!=null){for(var t=constraintLevel;t<folderTypes.length;t++){$("#editfoldertypelist").append("<li><a onclick='changeEditFolderType("+t+")'>"+folderTypes[t]+"</a></li>")}}else{$("#editfoldertypelist").append("<li><a onclick='changeEditFolderType(0)'>"+folderTypes[0]+"</a></li>")}});document.ondragover=function(e){if(e.preventDefault){e.preventDefault();e.stopPropagation()}else{window.event.cancelBubble=true;window.event.returnValue=false}};document.ondrop=function(e){if(e.preventDefault){e.preventDefault();e.stopPropagation()}else{window.event.cancelBubble=true;window.event.returnValue=false}if(folderView.authList!=null){if(checkAuth(folderView.authList,"U")){if(isUpLoading||isImporting){alert("提示：您正在执行另一项上传任务，请在上传窗口关闭后再试。")}else{if(!(window.ActiveXObject||"ActiveXObject"in window)){var t;if(e.dataTransfer!=null){t=e.dataTransfer}else{t=window.event.dataTransfer}var o=true;if(t.items!==undefined){for(var l=0;l<t.items.length;l++){var a=t.items[l];if(a.kind==="file"&&a.webkitGetAsEntry().isFile){}else{o=false}}}else{for(var l=0;l<t.files.length;l++){var r=df.files[l];if(r.type){}else{try{var i=new FileReader;i.readAsDataURL(r.slice(0,10));i.addEventListener("load",function(e){},false);i.addEventListener("error",function(e){o=false},false)}catch(e){o=false}}}}if(o){fs=e.dataTransfer.files;showUploadFileModel();showfilepath();checkUploadFile()}else{alert("提示：您拖入的文件中包含了一个或多个文件夹，无法进行上传。")}}else{alert("提示：IE浏览器不支持拖拽上传。您可以使用现代浏览器或将浏览模式切换为“极速模式”来体验该功能。")}}}else{alert("提示：您不具备上传权限，无法上传文件。")}}else{alert("提示：您不具备上传权限，无法上传文件。")}};$(document).keypress(function(e){if($(".modal.shown").length==0||$(".modal.shown").length==1&&$(".modal.shown").attr("id")=="loadingModal"){var t=e.keyCode?e.keyCode:e.which?e.which:e.charCode;if(isShift(e)&&document.activeElement.id!="sreachKeyWordIn"){switch(t){case 65:checkallfile();break;case 78:$("#createFolderButtonLi a").click();break;case 85:$("#uploadFileButtonLi a").click();break;case 68:$("#deleteSeelectFileButtonLi a").click();break;case 70:$("#uploadFolderButtonLi a").click();break;case 67:if(!$("#cutSignTx").hasClass("cuted")&&checkedMovefiles==undefined){$("#cutFileButtonLi a").click()}break;case 86:if($("#cutSignTx").hasClass("cuted")&&checkedMovefiles!==undefined){$("#cutFileButtonLi a").click()}break;default:return true}return false}}});$("#moveFilesModal").on("hidden.bs.modal",function(e){checkedMovefiles=undefined;$("#cutSignTx").html("剪切 <span class='pull-right'><span class='glyphicon glyphicon-arrow-up' aria-hidden='true'></span>+C</span>");$("#cutSignTx").removeClass("cuted");$("#moveFilesBox").html("")});if(typeof String.prototype.startsWith!="function"){String.prototype.startsWith=function(e){return this.slice(0,e.length)===e}}if(typeof String.prototype.endsWith!="function"){String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1}}$("#downloadModal").on("hidden.bs.modal",function(e){$("#downloadURLCollapse").collapse("hide")});updateWinHeight();$(window).scroll(function(){if($(this).scrollTop()>2*winHeight){$("#gobacktotopbox").removeClass("hidden")}else{$("#gobacktotopbox").addClass("hidden")}});$("#downloadURLCollapse").on("shown.bs.collapse",function(){getDownloadURL()});$("#changePasswordModal").on("show.bs.modal",function(e){if(!isChangingPassword){$("#changepassword_oldpwd,#changepassword_newpwd,#changepassword_reqnewpwd,#changePasswordButton,#changepassword_vercode").attr("disabled",false);$("#changepassword_oldepwdbox,#changepassword_newpwdbox,#changepassword_reqnewpwdbox").removeClass("has-error");$("#changepassword_oldpwd,#changepassword_newpwd,#changepassword_reqnewpwd").val("");$("#changepasswordalertbox,#changepassword_vccodebox").hide()}});$("#changePasswordModal").on("shown.bs.modal",function(e){if(!isChangingPassword){$("#changepassword_oldpwd").focus()}});$("#noticeModal").on("show.bs.modal",function(e){var t=document.cookie.match(new RegExp("(^| )notice_md5_30=([^;]*)(;|$)"));if(t){$("#dontShowSomeNoticeAt30Day").attr("checked","checked")}else{$("#dontShowSomeNoticeAt30Day").attr("checked",false)}});$("#noticeModal").on("hidden.bs.modal",function(e){var t=new Date;if($("#dontShowSomeNoticeAt30Day").prop("checked")){t.setTime(t.getTime()+30*24*60*60*1e3);var o=document.cookie.match(new RegExp("(^| )notice_md5=([^;]*)(;|$)"));if(o){document.cookie="notice_md5_30="+escape(unescape(o[2]))+";expires="+t.toUTCString()}else{o=document.cookie.match(new RegExp("(^| )notice_md5_30=([^;]*)(;|$)"));if(o){document.cookie="notice_md5_30="+escape(unescape(o[2]))+";expires="+t.toUTCString()}}}else{t.setTime(0);var l=document.cookie.match(new RegExp("(^| )notice_md5_30=([^;]*)(;|$)"));if(l){document.cookie="notice_md5_30=0;expires="+t.toUTCString()}}})});function updateWinHeight(){if(window.innerHeight){winHeight=window.innerHeight}else if(document.body&&document.body.clientHeight){winHeight=document.body.clientHeight}}function changeFilesTableStyle(){var e=$(window).width();if(e<768){$("#filetableheadera").addClass("filetableheaderstyle");$("#filetableheadera").attr("data-toggle","collapse");$("#filetableheadera").attr("data-target","#filetableoptmenu");$("#mdropdownicon").html("（点击展开/折叠菜单）")}else{$("#filetableheadera").removeClass("filetableheaderstyle");$("#filetableheadera").attr("data-toggle","modal");$("#filetableheadera").attr("data-target","#folderInfoModal");$("#mdropdownicon").html("")}}function doAlert(){alert("错误：无法连接到kiftd服务器，请检查您的网络连接或查看服务器运行状态。")}function getServerOS(){$.ajax({type:"POST",dataType:"text",data:{},url:"homeController/getServerOS.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html";return}$("#serverOS").text(e)},error:function(){$("#serverOS").html("<a onclick='getServerOS()'>获取失败，点击重试</a>")}})}function showFolderView(fid,targetId){if(loadingFolderView){return}startLoading();if(remainingLoadingRequest){remainingLoadingRequest.abort()}$.ajax({type:"POST",dataType:"text",data:{fid:fid},url:"homeController/getFolderView.ajax",success:function(result){endLoading();switch(result){case"ERROR":doAlert();$("#tb").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#publishTime").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#parentlistbox").html("<span class='graytext'>获取失败，请尝试刷新</span>");break;case"NOT_FOUND":case"notAccess":document.cookie="folder_id="+escape("root");case"mustLogin":window.location.href="/";break;default:folderView=eval("("+result+")");locationpath=folderView.folder.folderId;document.cookie="folder_id="+escape(locationpath);parentpath=folderView.folder.folderParent;constraintLevel=folderView.folder.folderConstraint;screenedFoldrView=null;originFolderView=$.extend(true,{},folderView);totalFoldersOffset=folderView.foldersOffset;totalFilesOffset=folderView.filesOffset;$("#sreachKeyWordIn").val("");showParentList(folderView);showAccountView(folderView);showPublishTime(folderView);$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();showFolderTable(folderView);$("#fim_name").text(folderView.folder.folderName);$("#fim_creator").text(folderView.folder.folderCreator);$("#fim_folderCreationDate").text(folderView.folder.folderCreationDate);$("#fim_folderId").text(folderView.folder.folderId);updateTheFolderInfo();if(folderView.foldersOffset>folderView.selectStep||folderView.filesOffset>folderView.selectStep){showLoadingRemaininngBox();loadingRemainingFolderView(targetId)}else{hiddenLoadingRemaininngBox();doFixedRow(targetId)}break}},error:function(e,t,o){endLoading();doAlert();$("#tb").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#publishTime").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#parentlistbox").html("<span class='graytext'>获取失败，请尝试刷新</span>")}})}function startLoading(){loadingFolderView=true;$("#loadingModal").modal({backdrop:"static",keyboard:false});$("#loadingModal").modal("show");$("#loadingModal").addClass("shown")}function endLoading(){loadingFolderView=false;$("#loadingModal").modal("hide");$("#loadingModal").removeClass("shown")}function startLogin(){$("#accountid").attr("disabled","disabled");$("#accountpwd").attr("disabled","disabled");$("#dologinButton").attr("disabled","disabled")}function finishLogin(){$("#accountid").removeAttr("disabled","disabled");$("#accountpwd").removeAttr("disabled","disabled");$("#dologinButton").removeAttr("disabled","disabled")}function dologin(){var accountId=$("#accountid").val();var accountPwd=$("#accountpwd").val();var check="y";if(accountId.length==0){$("#accountidbox").addClass("has-error");check="n"}else{$("#accountidbox").removeClass("has-error")}if(accountPwd.length==0){$("#accountpwdbox").addClass("has-error");check="n"}else{$("#accountpwdbox").removeClass("has-error")}if(check=="y"){startLogin();$.ajax({url:"homeController/getPublicKey.ajax",type:"POST",data:{},dataType:"text",success:function(result){var publicKeyInfo=eval("("+result+")");var date=new Date;var loginInfo='{accountId:"'+accountId+'",accountPwd:"'+accountPwd+'",time:"'+publicKeyInfo.time+'"}';var encrypt=new JSEncrypt;encrypt.setPublicKey(publicKeyInfo.publicKey);var encrypted=encrypt.encrypt(loginInfo);sendLoginInfo(encrypted)},error:function(){finishLogin();$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：登录请求失败，请检查网络或服务器运行状态")}})}}function sendLoginInfo(e){$.ajax({type:"POST",dataType:"text",url:"homeController/doLogin.ajax",data:{encrypted:e,vercode:$("#vercode").val()},success:function(e){finishLogin();$("#alertbox").removeClass("alert");$("#alertbox").removeClass("alert-danger");$("#alertbox").text("");$("#vercodebox").html("");$("#vercodebox").removeClass("show");$("#vercodebox").addClass("hidden");switch(e){case"permitlogin":$("#accountidbox").removeClass("has-error");$("#accountpwdbox").removeClass("has-error");$("#loginModal").modal("hide");showFolderView(locationpath);break;case"accountnotfound":$("#accountidbox").addClass("has-error");$("#accountpwdbox").removeClass("has-error");$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：登录失败，账户不存在或未设置");break;case"accountpwderror":$("#accountpwdbox").addClass("has-error");$("#accountidbox").removeClass("has-error");$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：登录失败，密码错误或未设置");break;case"needsubmitvercode":$("#vercodebox").html("<label id='vercodetitle' class='col-sm-7'><img id='showvercode' class='vercodeimg' alt='点击获取验证码' src='homeController/getNewVerCode.do?s="+(new Date).getTime()+"' onclick='getNewVerCode()'></label><div class='col-sm-5'><input type='text' class='form-control' id='vercode' placeholder='验证码……'></div>");$("#vercodebox").removeClass("hidden");$("#vercodebox").addClass("show");break;case"error":$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：登录失败，登录请求无法通过加密效验（可能是请求耗时过长导致的）");break;default:$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：无法登录，未知错误");break}},error:function(){finishLogin();$("#alertbox").addClass("alert");$("#alertbox").addClass("alert-danger");$("#alertbox").text("提示：登录请求失败，请检查网络或服务器运行状态")}})}function getNewVerCode(){$("#showvercode").attr("src","homeController/getNewVerCode.do?s="+(new Date).getTime())}function dologout(){$("#logoutModal").modal("hide");$.ajax({url:"homeController/doLogout.ajax",type:"POST",data:{},dataType:"text",success:function(e){if(e=="SUCCESS"){showFolderView(locationpath)}},error:function(){doAlert()}})}function showParentList(e){$("#parentFolderList").html("");var t=e.folder;if(e.parentList.length>0){$.each(e.parentList,function(e,t){$("#parentFolderList").append("<li><a href='javascript:void(0);' onclick='entryFolder("+'"'+t.folderId+'"'+")'>"+t.folderName+"</a></li>")})}else{$("#parentFolderList").html("<li class='disabled'><a>无</a></li>")}if(t.folderName.length>6){$("#currentFolderName").text(t.folderName.substr(0,6)+"...")}else{$("#currentFolderName").text(t.folderName)}if(t.folderName=="ROOT"){$("#folderIconSpan").removeClass("glyphicon-folder-close");$("#folderIconSpan").removeClass("glyphicon-search");$("#folderIconSpan").addClass("glyphicon-home")}else if(e.keyWorld!=null){$("#folderIconSpan").removeClass("glyphicon-folder-close");$("#folderIconSpan").removeClass("glyphicon-home");$("#folderIconSpan").addClass("glyphicon-search")}else{$("#folderIconSpan").removeClass("glyphicon-home");$("#folderIconSpan").removeClass("glyphicon-search");$("#folderIconSpan").addClass("glyphicon-folder-close")}}function showAccountView(e){$("#tb,#tb2").html("");account=e.account;if(e.account!=null){$("#tb").append("<button class='btn btn-link rightbtn hidden-xs' data-toggle='modal' data-target='#logoutModal'>注销 ["+e.account+"] <span class='glyphicon glyphicon-off' aria-hidden='true'></span></button>");$("#tb2").append("<button class='btn btn-link' data-toggle='modal' data-target='#logoutModal'>注销 ["+e.account+"] <span class='glyphicon glyphicon-off' aria-hidden='true'></span></button>");if(e.allowChangePassword=="true"){$("#tb").append(" <button class='btn btn-link rightbtn hidden-xs' data-toggle='modal' data-target='#changePasswordModal'>修改密码 <span class='glyphicon glyphicon-edit' aria-hidden='true'></span></button>");$("#tb2").append(" <button class='btn btn-link' data-toggle='modal' data-target='#changePasswordModal'>修改密码 <span class='glyphicon glyphicon-edit' aria-hidden='true'></span></button>")}}else{$("#tb").append("<button class='btn btn-link rightbtn hidden-xs' data-toggle='modal' data-target='#loginModal'>登入 <span class='glyphicon glyphicon-user' aria-hidden='true'></span></button>");$("#tb2").append("<button class='btn btn-link' data-toggle='modal' data-target='#loginModal'>登入 <span class='glyphicon glyphicon-user' aria-hidden='true'></span></button>");if(e.allowSignUp=="true"){$("#tb").append(" <button class='btn btn-link rightbtn hidden-xs' onclick='window.location.href = \"/prv/signup.html\"'>立即注册 <span class='glyphicon glyphicon-log-in' aria-hidden='true'></span></button>");$("#tb2").append(" <button class='btn btn-link' onclick='window.location.href = \"prv/signup.html\"'>立即注册 <span class='glyphicon glyphicon-log-in' aria-hidden='true'></span></button>")}}var t=e.authList;$("#fileListDropDown li").addClass("disabled");$("#fileListDropDown li a").attr("onclick","");$("#fileListDropDown li a").attr("href","javascript:void(0);");if(t!=null){if(checkAuth(t,"C")){$("#createFolderButtonLi").removeClass("disabled");$("#createFolderButtonLi a").attr("onclick","showNewFolderModel()")}if(checkAuth(t,"U")){$("#uploadFileButtonLi").removeClass("disabled");$("#uploadFileButtonLi a").attr("onclick","showUploadFileModel()");if(checkAuth(t,"C")&&isSupportWebkitdirectory()){$("#uploadFolderButtonLi").removeClass("disabled");$("#uploadFolderButtonLi a").attr("onclick","showUploadFolderModel()")}}if(e.enableDownloadZip&&checkAuth(t,"L")){$("#packageDownloadBox").html("<button class='btn btn-link navbar-btn' onclick='showDownloadAllCheckedModel()'><span class='glyphicon glyphicon-briefcase'></span> 打包下载</button>")}else{$("#packageDownloadBox").html("")}if(checkAuth(t,"D")){$("#deleteSeelectFileButtonLi").removeClass("disabled");$("#deleteSeelectFileButtonLi a").attr("onclick","showDeleteAllCheckedModel()")}if(checkAuth(t,"M")){$("#cutFileButtonLi").removeClass("disabled");$("#cutFileButtonLi a").attr("onclick","startMoveFile()");if(checkedMovefiles!==undefined&&checkedMovefiles.length>0){$("#cutSignTx").text("粘贴（"+checkedMovefiles.length+"）");$("#cutSignTx").addClass("cuted")}}}}function checkAuth(e,t){var o=false;$.each(e,function(e,l){if(l==t){o=true}});return o}function showPublishTime(e){$("#publishTime").html("");var t="";if(e.publishTime!=null){t=e.publishTime}else{t="--"}$("#publishTime").text(t)}function refreshFolderView(){if(locationpath!=null&&locationpath.length>0){showFolderView(locationpath)}else{showFolderView("root")}subscribeNotice()}function returnPF(){if(parentpath!=null&&parentpath!="null"){showFolderView(parentpath)}else{showFolderView("root")}}function showFolderTable(e){$("#foldertable").html("");if(parentpath!=null&&parentpath!="null"){$("#foldertable").append("<tr onclick='returnPF()'><td><button onclick='' class='btn btn-link btn-xs'>../</button></td><td class='hidden-xs'>--</td><td>--</td><td class='hidden-xs'>--</td><td>--</td></tr>")}var t=e.authList;var o=false;var l=false;var a=false;var r=false;if(checkAuth(t,"D")){o=true}if(checkAuth(t,"R")){l=true}if(checkAuth(t,"L")){a=true}if(checkAuth(t,"O")){r=true}for(var i=e.folderList.length;i>0;i--){var s=e.folderList[i-1];$("#foldertable").append(createNewFolderRow(s,o,l,r))}for(var n=e.fileList.length;n>0;n--){var d=e.fileList[n-1];$("#foldertable").append(createFileRow(d,a,o,l,r))}}function createFileRow(e,t,o,l,a){e.fileName=e.fileName.replace(/\'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var r="<tr id="+e.fileId+" onclick='checkfile(event,"+'"'+e.fileId+'"'+")' ondblclick='checkConsFile(event,"+'"'+e.fileId+'"'+")' id='"+e.fileId+"' class='filerow'><td>"+e.fileName+"</td><td class='hidden-xs'>"+e.fileCreationDate+"</td>";if(e.fileSize=="0"){r=r+"<td>&lt;1MB</td>"}else{r=r+"<td>"+e.fileSize+"MB</td>"}r=r+"<td class='hidden-xs'>"+e.fileCreator+"</td><td>";if(t){r=r+"<button onclick='showDownloadModel("+'"'+e.fileId+'","'+e.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-cloud-download'></span> 下载</button>";var i=getSuffix(e.fileName);switch(i){case"mp4":r=r+"<button onclick='playVideo("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-play'></span> 播放</button>";break;case"webm":case"mov":case"avi":case"wmv":case"mkv":case"flv":if(folderView.enableFFMPEG){r=r+"<button onclick='playVideo("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-play'></span> 播放</button>"}break;case"pdf":r=r+"<button onclick='pdfView("+'"'+e.filePath+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-eye-open'></span> 预览</button>";break;case"jpg":case"jpeg":case"gif":case"png":case"bmp":r=r+"<button onclick='showPicture("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-picture'></span> 查看</button>";break;case"mp3":case"wav":case"ogg":r=r+"<button onclick='playAudio("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-play'></span> 播放</button>";break;case"docx":r=r+"<button onclick='docxView("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-eye-open'></span> 预览</button>";break;case"txt":r=r+"<button onclick='txtView("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-eye-open'></span> 预览</button>";break;case"ppt":case"pptx":r=r+"<button onclick='pptView("+'"'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-eye-open'></span> 预览</button>";break;default:break}}if(o){r=r+"<button onclick='showDeleteFileModel("+'"'+e.fileId+'","'+e.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-remove'></span> 删除</button>"}if(l){r=r+"<button onclick='showRenameFileModel("+'"'+e.fileId+'"'+","+'"'+e.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-wrench'></span> 重命名</button>"}if(a){r=r+"<button onclick='showFolderView("+'"'+e.fileParentFolder+'","'+e.fileId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-sunglasses'></span> 定位</button>"}if(t&&folderView.showFileChain=="true"){r=r+"<button onclick='getFileChain("+'"'+e.fileId+'","'+e.fileName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-link'></span> 链接</button>"}if(!l&&!o&&!t&&!a){r=r+"--"}r=r+"</td></tr>";return r}function createNewFolderRow(e,t,o,l){e.folderName=e.folderName.replace(/\'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var a="<tr id='"+e.folderId+"' onclick='checkfile(event,"+'"'+e.folderId+'"'+")' ondblclick='checkConsFile(event,"+'"'+e.folderId+'"'+")' class='filerow' iskfolder='true' ><td><button onclick='entryFolder("+'"'+e.folderId+'"'+")' class='btn btn-link btn-xs'>/"+e.folderName+"</button></td><td class='hidden-xs'>"+e.folderCreationDate+"</td><td>--</td><td class='hidden-xs'>"+e.folderCreator+"</td><td>";if(t){a=a+"<button onclick='showDeleteFolderModel("+'"'+e.folderId+'","'+e.folderName+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-remove'></span> 删除</button>"}if(o){a=a+"<button onclick='showRenameFolderModel("+'"'+e.folderId+'","'+e.folderName+'",'+e.folderConstraint+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-wrench'></span> 编辑</button>"}if(l){a=a+"<button onclick='showFolderView("+'"'+e.folderParent+'","'+e.folderId+'"'+")' class='btn btn-link btn-xs'><span class='glyphicon glyphicon-sunglasses'></span> 定位</button>"}if(!o&&!t&&!l){a=a+"--"}a=a+"</td></tr>";return a}var folderTypes=["公开的","仅小组","仅创建者"];function showNewFolderModel(){$("#newFolderModal").modal("show")}function changeNewFolderType(e){$("#newfoldertype").text(folderTypes[e]);$("#foldername").attr("folderConstraintLevel",e+"")}function createfolder(){var e=$("#foldername").val();var t=$("#foldername").attr("folderConstraintLevel");var o=new RegExp("[/|\\\\*\\<\\>\\?\\:\\&\\$"+'"'+"]+","g");if(e.length==0){showFolderAlert("提示：文件夹名称不能为空。")}else if(e.length>128){showFolderAlert("提示：文件夹名称太长。")}else if(!o.test(e)&&e.indexOf(".")!=0){$("#folderalert").removeClass("alert");$("#folderalert").removeClass("alert-danger");$("#foldernamebox").removeClass("has-error");$("#folderalert").text("");$.ajax({type:"POST",dataType:"text",data:{parentId:locationpath,folderName:e,folderConstraint:t},url:"homeController/newFolder.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{switch(e){case"noAuthorized":showFolderAlert("提示：您的操作未被授权，创建文件夹失败。");break;case"errorParameter":showFolderAlert("提示：参数不正确，创建文件夹失败。");break;case"cannotCreateFolder":showFolderAlert("提示：出现意外错误，可能未能创建文件夹。");break;case"nameOccupied":showFolderAlert("提示：该名称已被占用，请选取其他名称。");break;case"foldersTotalOutOfLimit":showFolderAlert("提示：该文件夹内存储的文件夹数量已达上限，无法在其中创建更多文件夹。");break;case"createFolderSuccess":$("#newFolderModal").modal("hide");showFolderView(locationpath);break;default:$("#newFolderModal").modal("hide");showFolderView(locationpath);break}}},error:function(){showFolderAlert("提示：出现意外错误，可能未能创建文件夹")}})}else{showFolderAlert("提示：文件夹名中不应含有：引号 / \\ * | < > & $ : ? 且不能以“.”开头。")}}function showFolderAlert(e){$("#folderalert").addClass("alert");$("#folderalert").addClass("alert-danger");$("#foldernamebox").addClass("has-error");$("#folderalert").text(e)}function entryFolder(e){showFolderView(e)}function showDeleteFolderModel(e,t){$("#deleteFolderBox").html("<button id='dmbutton' type='button' class='btn btn-danger' onclick='deleteFolder("+'"'+e+'"'+")'>删除</button>");$("#dmbutton").attr("disabled",false);$("#deleteFolderMessage").text("提示：确定要彻底删除文件夹：["+t+"]及其全部内容么？该操作不可恢复");$("#deleteFolderModal").modal("toggle")}function deleteFolder(e){$("#dmbutton").attr("disabled",true);$("#deleteFolderMessage").text("提示：正在删除，请稍候...");$.ajax({type:"POST",dataType:"text",data:{folderId:e},url:"homeController/deleteFolder.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{if(e=="noAuthorized"){$("#deleteFolderMessage").text("提示：您的操作未被授权，删除文件夹失败");$("#dmbutton").attr("disabled",false)}else if(e=="errorParameter"){$("#deleteFolderMessage").text("提示：参数不正确，删除文件夹失败");$("#dmbutton").attr("disabled",false)}else if(e=="cannotDeleteFolder"){$("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹");$("#dmbutton").attr("disabled",false)}else if(e=="deleteFolderSuccess"){$("#deleteFolderModal").modal("hide");showFolderView(locationpath)}else{$("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹");$("#dmbutton").attr("disabled",false)}}},error:function(){$("#deleteFolderMessage").text("提示：出现意外错误，可能未能删除文件夹");$("#dmbutton").attr("disabled",false)}})}function showRenameFolderModel(e,t,o){$("#renameFolderBox").html("<button type='button' class='btn btn-primary' onclick='renameFolder("+'"'+e+'"'+")'>修改</button>");$("#newfoldername").val(t);changeEditFolderType(o);$("#renameFolderModal").modal("show")}function changeEditFolderType(e){$("#editfoldertype").text(folderTypes[e]);$("#newfoldername").attr("folderConstraintLevel",e+"")}function renameFolder(e){var t=$("#newfoldername").val();var o=$("#newfoldername").attr("folderConstraintLevel");var l=new RegExp("[/|\\\\*\\<\\>\\?\\:\\&\\$"+'"'+"]+","g");if(t.length==0){showRFolderAlert("提示：文件夹名称不能为空。")}else if(t.length>128){showRFolderAlert("提示：文件夹名称太长。")}else if(!l.test(t)&&t.indexOf(".")!=0){$("#newfolderalert").removeClass("alert");$("#newfolderalert").removeClass("alert-danger");$("#folderrenamebox").removeClass("has-error");$("#newfolderalert").text("");$.ajax({type:"POST",dataType:"text",data:{folderId:e,newName:t,folderConstraint:o},url:"homeController/renameFolder.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{if(e=="noAuthorized"){showRFolderAlert("提示：您的操作未被授权，编辑失败。")}else if(e=="errorParameter"){showRFolderAlert("提示：参数不正确，编辑失败，请刷新后重试。")}else if(e=="nameOccupied"){showRFolderAlert("提示：该名称已被占用，请选取其他名称。")}else if(e=="renameFolderSuccess"){$("#renameFolderModal").modal("hide");showFolderView(locationpath)}else{showRFolderAlert("提示：出现意外错误，可能未能编辑文件夹，请刷新后重试。")}}},error:function(){showRFolderAlert("提示：出现意外错误，可能未能编辑文件夹，请刷新后重试。")}})}else{showRFolderAlert("提示：文件夹名中不应含有：引号 / \\ * | < > & $ : ? 且不能以“.”开头。")}}function showRFolderAlert(e){$("#editfolderalert").addClass("alert");$("#editfolderalert").addClass("alert-danger");$("#folderrenamebox").addClass("has-error");$("#editfolderalert").text(e)}function showUploadFileModel(){$("#uploadFileAlert").hide();$("#uploadFileAlert").text("");if(isUpLoading==false){$("#filepath").removeAttr("disabled");$("#uploadfile").val("");$("#filepath").val("");$("#pros").width("0%");$("#pros").attr("aria-valuenow","0");$("#umbutton").attr("disabled",false);$("#filecount").text("");$("#uploadstatus").html("");$("#selectcount").text("");$("#selectFileUpLoadModelAsAll").removeAttr("checked");$("#selectFileUpLoadModelAlert").hide()}$("#uploadFileModal").modal("show")}function checkpath(){$("#uploadfile").click()}function getInputUpload(){fs=$("#uploadfile").get(0).files;showfilepath()}function showfilepath(){var e="";for(var t=0;t<fs.length;t++){e=e+fs[t].name;if(t<fs.length-1){e=e+"、"}}if(fs.length<=1){$("#selectcount").text("")}else{$("#selectcount").text("（共"+fs.length+"个）")}$("#filepath").val(e)}function checkUploadFile(){if(isUpLoading==false&&isImporting==false){if(fs!=null&&fs.length>0){$("#filepath").attr("disabled","disabled");$("#umbutton").attr("disabled",true);isUpLoading=true;repeModelList=null;$("#uploadFileAlert").hide();$("#uploadFileAlert").text("");var filenames=new Array;var maxSize=0;var maxFileIndex=0;for(var i=0;i<fs.length;i++){filenames[i]=fs[i].name.replace(/^.+?\\([^\\]+?)?$/gi,"$1");if(fs[i].size>maxSize){maxSize=fs[i].size;maxFileIndex=i}}var namelist=JSON.stringify(filenames);$.ajax({type:"POST",dataType:"text",data:{folderId:locationpath,namelist:namelist,maxSize:maxSize,maxFileIndex:maxFileIndex},url:"homeController/checkUploadFile.ajax",success:function(result){if(result=="mustLogin"){window.location.href="prv/login.html"}else{switch(result){case"errorParameter":showUploadFileAlert("提示：参数不正确，无法开始上传");break;case"noAuthorized":showUploadFileAlert("提示：您的操作未被授权，无法开始上传");break;case"filesTotalOutOfLimit":showUploadFileAlert("提示：该文件夹内存储的文件数量已达上限，无法在其中上传更多文件。您可以尝试将其上传至其他文件夹内。");break;default:var resp=eval("("+result+")");if(resp.checkResult=="fileTooLarge"){showUploadFileAlert("提示：文件["+resp.overSizeFile+"]的体积超过最大限制（"+resp.maxUploadFileSize+"），无法开始上传")}else if(resp.checkResult=="hasExistsNames"){repeList=resp.pereFileNameList;repeIndex=0;selectFileUpLoadModelStart()}else if(resp.checkResult=="permitUpload"){doupload(1)}else{showUploadFileAlert("提示：出现意外错误，无法开始上传")}break}}},error:function(){showUploadFileAlert("提示：出现意外错误，无法开始上传")}})}else{showUploadFileAlert("提示：您未选择任何文件，无法开始上传")}}else{showUploadFileAlert("提示：另一项上传文件或文件夹的任务尚未完成，无法开始上传")}}var repeList;var repeIndex;var repeModelList;function selectFileUpLoadModelStart(){var e=originFolderView.authList;if(checkAuth(e,"D")){$("#uploadcoverbtn").show()}else{$("#uploadcoverbtn").hide()}$("#selectFileUpLoadModelAlert").show();$("#repeFileName").text(repeList[repeIndex])}function selectFileUpLoadModelEnd(e){if(repeModelList==null){repeModelList={}}repeModelList[$("#repeFileName").text()]=e;$("#selectFileUpLoadModelAlert").hide();if($("#selectFileUpLoadModelAsAll").prop("checked")){for(var t=repeIndex;t<repeList.length;t++){repeModelList[repeList[t]]=e}doupload(1)}else{repeIndex++;if(repeIndex<repeList.length){selectFileUpLoadModelStart()}else{doupload(1)}}}function doupload(e){var t=fs.length;$("#pros").width("0%");$("#pros").attr("aria-valuenow","0");var o=fs[e-1];if(o!=null){var l=o.name;if(t>1){$("#filecount").text("（"+e+"/"+t+"）")}$("#uploadstatus").prepend("<p>"+l+"<span id='uls_"+e+"'>[正在上传...]</span></p>");xhr=new XMLHttpRequest;var a=new FormData;a.append("file",o);a.append("folderId",locationpath);if(repeModelList!=null&&repeModelList[l]!=null){if(repeModelList[l]=="skip"){$("#uls_"+e).text("[已完成]");if(e<t){doupload(e+1);return}else{isUpLoading=false;$("#filepath").removeAttr("disabled");$("#uploadfile").val("");$("#filepath").val("");$("#pros").width("0%");$("#pros").attr("aria-valuenow","0");$("#umbutton").attr("disabled",false);$("#filecount").text("");$("#uploadstatus").text("");$("#selectcount").text("");$("#uploadFileModal").modal("hide");showFolderView(locationpath);return}}a.append("repeType",repeModelList[l])}xhr.open("POST","homeController/douploadFile.ajax",true);xhr.upload.addEventListener("progress",uploadProgress,false);xhr.send(a);if(pingInt==null){pingInt=setInterval("ping()",6e4)}xhr.onloadend=function(){if(pingInt!=null){window.clearInterval(pingInt);pingInt=null}if(xhr.status===200){var o=xhr.responseText;if(o=="uploadsuccess"){$("#uls_"+e).text("[已完成]");if(e<t){doupload(e+1)}else{isUpLoading=false;$("#filepath").removeAttr("disabled");$("#uploadfile").val("");$("#filepath").val("");$("#pros").width("0%");$("#pros").attr("aria-valuenow","0");$("#umbutton").attr("disabled",false);$("#filecount").text("");$("#uploadstatus").text("");$("#selectcount").text("");$("#uploadFileModal").modal("hide");showFolderView(locationpath)}}else if(o=="uploaderror"){showUploadFileAlert("提示：出现意外错误，文件：["+l+"]上传失败，上传被中断。");$("#uls_"+e).text("[失败]")}else if(o=="filesTotalOutOfLimit"){showUploadFileAlert("提示：该文件夹内存储的文件数量已达上限，文件：["+l+"]上传失败。您可以尝试将其上传至其他文件夹内。");$("#uls_"+e).text("[失败]")}else{showUploadFileAlert("提示：出现意外错误，文件：["+l+"]上传失败，上传被中断。");$("#uls_"+e).text("[失败]")}}else{showUploadFileAlert("提示：出现意外错误，文件：["+l+"]上传失败，上传被中断。");$("#uls_"+e).text("[失败]")}}}else{showUploadFileAlert("提示：要上传的文件不存在。");$("#uploadstatus").prepend("<p>未找到要上传的文件<span id='uls_"+e+"'>[失败]</span></p>")}}function uploadProgress(e){if(e.lengthComputable){var t=Math.round(e.loaded*100/e.total);$("#pros").width(t+"%");$("#pros").attr("aria-valuenow",""+t)}}function showUploadFileAlert(e){isUpLoading=false;$("#filepath").removeAttr("disabled");$("#uploadFileAlert").show();$("#uploadFileAlert").text(e);$("#umbutton").attr("disabled",false)}function abortUpload(){isUpLoading=false;if(xhr!=null){xhr.abort()}$("#uploadFileModal").modal("hide");showFolderView(locationpath)}function showDownloadModel(e,t){$("#downloadFileName").text("提示：您确认要下载文件：["+t+"]么？");$("#downloadHrefBox").html("<span class='text-muted'>正在生成...</span>");getDownloadFileId=e;getDownloadFileName=t;$("#downloadFileBox").html("<button id='dlmbutton' type='button' class='btn btn-primary' onclick='dodownload("+'"'+e+'"'+")'>开始下载</button>");$("#dlmbutton").attr("disabled",false);$("#downloadModal").modal("show")}function dodownload(e){$("#dlmbutton").attr("disabled",true);$("#downloadFileName").text("提示：准备开始下载，请稍候...");var t=setTimeout("$('#downloadModal').modal('hide');",800);window.location.href="homeController/downloadFile.do?fileId="+e}function showDeleteFileModel(e,t){$("#deleteFileBox").html("<button id='dfmbutton' type='button' class='btn btn-danger' onclick='deleteFile("+'"'+e+'"'+")'>删除</button>");$("#dfmbutton").attr("disabled",false);$("#deleteFileMessage").text("提示：确定要彻底删除文件：["+t+"]么？该操作不可恢复");$("#deleteFileModal").modal("toggle")}function deleteFile(e){$("#dfmbutton").attr("disabled",true);$("#deleteFileMessage").text("提示：正在删除，请稍候...");$.ajax({type:"POST",dataType:"text",data:{fileId:e},url:"homeController/deleteFile.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{if(e=="noAuthorized"){$("#deleteFileMessage").text("提示：您的操作未被授权，删除失败");$("#dfmbutton").attr("disabled",false)}else if(e=="errorParameter"){$("#deleteFileMessage").text("提示：参数不正确，删除失败");$("#dfmbutton").attr("disabled",false)}else if(e=="cannotDeleteFile"){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件");$("#dfmbutton").attr("disabled",false)}else if(e=="deleteFileSuccess"){$("#deleteFileModal").modal("hide");showFolderView(locationpath)}else{$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件");$("#dfmbutton").attr("disabled",false)}}},error:function(){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除文件");$("#dfmbutton").attr("disabled",false)}})}function showRenameFileModel(e,t){$("#newFileNamealert").removeClass("alert");$("#newFileNamealert").removeClass("alert-danger");$("#filerenamebox").removeClass("has-error");$("#newFileNamealert").text("");$("#renameFileBox").html("<button type='button' class='btn btn-primary' onclick='renameFile("+'"'+e+'"'+")'>修改</button>");$("#newfilename").val(t);$("#renameFileModal").modal("toggle")}function renameFile(e){var t=new RegExp("[/|\\\\*\\<\\>\\?\\:\\&\\$"+'"'+"]+","g");var o=$("#newfilename").val();if(o.length>0){if(o.length<128){if(!t.test(o)&&o.indexOf(".")!=0){$.ajax({type:"POST",dataType:"text",data:{fileId:e,newFileName:o},url:"homeController/renameFile.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{if(e=="cannotRenameFile"){showRFileAlert("提示：出现意外错误，可能未能重命名文件，请刷新后重试。")}else if(e=="renameFileSuccess"){$("#renameFileModal").modal("hide");showFolderView(locationpath)}else if(e=="errorParameter"){showRFileAlert("提示：参数错误，重命名失败，请刷新后重试。")}else if(e=="nameOccupied"){showRFileAlert("提示：该名称已被占用，请选取其他名称。")}else if(e=="noAuthorized"){showRFileAlert("提示：您的操作未被授权，重命名失败，请刷新后重试。")}else{showRFileAlert("提示：出现意外错误，可能未能重命名文件，请刷新后重试。")}}},error:function(){showRFileAlert("提示：出现意外错误，可能未能重命名文件。")}})}else{showRFileAlert("提示：文件名中不应含有：引号 / \\ * | < > & $ : ? 且不能以“.”开头。")}}else{showRFileAlert("提示：文件名称太长。")}}else{showRFileAlert("提示：文件名不能为空。")}}function showRFileAlert(e){$("#newFileNamealert").addClass("alert");$("#newFileNamealert").addClass("alert-danger");$("#filerenamebox").addClass("has-error");$("#newFileNamealert").text(e)}function getSuffix(e){var t=e.lastIndexOf(".");var o=e.length;var l=e.substring(t+1,o);return l.toLowerCase()}function playVideo(e){window.open("quickview/video.html?fileId="+e)}function pdfView(e){window.open("/pdfview/web/viewer.html?file=/fileblocks/"+e)}function docxView(e){window.open("/pdfview/web/viewer.html?file=/resourceController/getWordView/"+e)}function txtView(e){window.open("/pdfview/web/viewer.html?file=/resourceController/getTxtView/"+e)}function pptView(e){window.open("/pdfview/web/viewer.html?file=/resourceController/getPPTView/"+e)}function showPicture(fileId){$.ajax({url:"homeController/getPrePicture.ajax",data:{fileId:fileId},type:"POST",dataType:"text",success:function(result){if(result!="ERROR"){pvl=eval("("+result+")");if(pvl.pictureViewList.length<=viewerPageSize){createViewList()}else{viewerPageIndex=Math.ceil((pvl.index+1)/viewerPageSize);viewerTotal=Math.ceil(pvl.pictureViewList.length/viewerPageSize);createViewListByPage();var innerIndex=pvl.index-(viewerPageIndex-1)*viewerPageSize;if(viewerPageIndex>1){innerIndex++}viewer.viewer("view",innerIndex);viewer.viewer("show",true)}}else{alert("错误：无法定位要预览的文件或该操作未被授权。")}},error:function(){alert("错误：请求失败，请刷新重试。")}})}function createViewList(){if(viewer==null){var e=document.createElement("ul");for(var t=0;t<pvl.pictureViewList.length;t++){if(pvl.pictureViewList[t].filePath.startsWith("homeController")){$(e).append("<li><img src='"+pvl.pictureViewList[t].filePath+"' alt='"+pvl.pictureViewList[t].fileName+"' /></li>")}else{$(e).append("<li><img src='fileblocks/"+pvl.pictureViewList[t].filePath+"' alt='"+pvl.pictureViewList[t].fileName+"' /></li>")}}viewer=$(e);viewer.viewer({loop:false,hidden:function(){viewer.data("viewer").destroy();viewer=null}})}viewer.viewer("view",pvl.index);viewer.viewer("show",true)}function createViewListByPage(){if(viewer==null){var e=document.createElement("ul");var t=(viewerPageIndex-1)*viewerPageSize;if(viewerPageIndex>1){$(e).append("<li><img src='css/left.png' alt='上一页' /></li>")}for(var o=0;o<viewerPageSize&&o<pvl.pictureViewList.length-(viewerPageIndex-1)*viewerPageSize;o++){if(pvl.pictureViewList[t+o].filePath.startsWith("homeController")){$(e).append("<li><img src='"+pvl.pictureViewList[t+o].filePath+"' alt='"+pvl.pictureViewList[t+o].fileName+"' /></li>")}else{$(e).append("<li><img src='fileblocks/"+pvl.pictureViewList[t+o].filePath+"' alt='"+pvl.pictureViewList[t+o].fileName+"' /></li>")}}if(viewerPageIndex<viewerTotal){$(e).append("<li><img src='css/right.png' alt='下一页' /></li>")}viewer=$(e);viewer.viewer({loop:false,view:function(e){if(e.detail.index==0&&viewerPageIndex!=1){viewerPageIndex--;viewer.data("viewer").destroy();viewer.empty();viewer=null;createViewListByPage();if(viewerPageIndex>1){viewer.viewer("view",viewerPageSize)}else{viewer.viewer("view",viewerPageSize-1)}}else if(e.detail.index==viewerPageSize+1||e.detail.index==viewerPageSize&&viewerPageIndex==1){viewerPageIndex++;viewer.data("viewer").destroy();viewer.empty();viewer=null;createViewListByPage();viewer.viewer("view",1)}},hidden:function(){viewer.data("viewer").destroy();viewer.empty();viewer=null}})}}function isShift(e){var t=window.event||e;if(t.shiftKey){return true}else{return false}}function checkfile(e,t){if(!isShift(e)){$(".filerow").removeClass("info");$("#"+t).addClass("info")}else{if($("#"+t).hasClass("info")){$("#"+t).removeClass("info")}else{$("#"+t).addClass("info")}}}function checkConsFile(e,t){if(isShift(e)){var o=$("#"+t);var l=o.index();var a=$(".filerow.info:last").index();if(a!=-1){if(a<l){while(o[0]&&!o.hasClass("info")){o.addClass("info");o=o.prev()}}else{while(o[0]&&!o.hasClass("info")){o.addClass("info");o=o.next()}}}}}function getCheckedFilesAndFolders(){var e=new Object;e.size=0;var t=new Array;var o=new Array;var l=$(".info").get();for(var a=0;a<l.length;a++){if(l[a].getAttribute("iskfolder")=="true"){o.push(l[a].id)}else{t.push(l[a].id)}e.size++}e.filesId=JSON.stringify(t);e.foldersId=JSON.stringify(o);return e}function checkallfile(){if($(".filerow.info").length==$(".filerow").length){$(".filerow").removeClass("info")}else{$(".filerow").addClass("info")}}function showDownloadAllCheckedModel(){if(!folderView.enableDownloadZip){return}$("#downloadAllCheckedBox").html("");$("#downloadAllCheckedLoad").text("");var e=getCheckedFilesAndFolders();if(e.size==0){$("#downloadAllCheckedName").html(checkFilesTip)}else{$("#downloadAllCheckedName").text("提示：您确认要打包并下载这"+e.size+"项么？");$("#downloadAllCheckedBox").html("<button id='dclmbutton' type='button' class='btn btn-primary' onclick='downloadAllChecked()'>开始下载</button>");$("#dclmbutton").attr("disabled",false)}$("#downloadAllCheckedModal").modal("toggle")}function downloadAllChecked(){$("#dclmbutton").attr("disabled",true);var e=getCheckedFilesAndFolders();$("#downloadAllCheckedName").text("提示：服务器正在对选中资源进行压缩（共"+e.size+"项），这可能需要一些时间（文件越大耗时越长），压缩完成将自动开始下载。");$.ajax({url:"homeController/getPackTime.ajax",type:"POST",data:{strIdList:e.filesId,strFidList:e.foldersId},dataType:"text",success:function(e){if(e!="0"){var t=0;$("#downloadAllCheckedLoad").text("已耗时："+t+"秒（预计耗时："+e+"）");zipTimer=setInterval(function(){t++;$("#downloadAllCheckedLoad").text("已耗时："+t+"秒（预计耗时："+e+"）")},1e3)}else{var t=0;$("#downloadAllCheckedLoad").text("已耗时："+t+"秒");zipTimer=setInterval(function(){t++;$("#downloadAllCheckedLoad").text("已耗时："+t+"秒")},1e3)}},error:function(){$("#downloadAllCheckedLoad").text("（无法获取预计耗时）")}});$.ajax({type:"POST",url:"homeController/downloadCheckedFiles.ajax",data:{strIdList:e.filesId,strFidList:e.foldersId},dataType:"text",success:function(e){if(zipTimer!=null){window.clearInterval(zipTimer)}if(e=="ERROR"){$("#downloadAllCheckedName").text("提示：压缩过程出错。无法完成压缩，请重试或告知管理员。")}else{$("#downloadAllCheckedLoad").text("");$("#downloadAllCheckedName").text("提示：压缩完成！准备开始下载...");var t=setTimeout("$('#downloadAllCheckedModal').modal('hide');",800);var o=document.createElement("form");o.action="homeController/downloadCheckedFilesZip.do";o.method="post";o.style.display="none";var l=document.createElement("input");l.name="zipId";l.value=e;o.appendChild(l);document.body.appendChild(o);o.submit()}},error:function(){$("#downloadAllCheckedName").text("提示：请求失败。无法完成压缩，请重试或告知管理员。")}})}function showDeleteAllCheckedModel(){$("#deleteFileBox").html("");var e=getCheckedFilesAndFolders();$("#dfmbutton").attr("disabled",false);if(e.size==0){$("#deleteFileMessage").html(checkFilesTip)}else{$("#deleteFileBox").html("<button id='dfmbutton' type='button' class='btn btn-danger' onclick='deleteAllChecked()'>全部删除</button>");$("#deleteFileMessage").text("提示：确定要彻底删除这"+e.size+"项么？该操作不可恢复！")}$("#deleteFileModal").modal("toggle")}function deleteAllChecked(){var e=getCheckedFilesAndFolders();$("#dfmbutton").attr("disabled",true);$("#deleteFileMessage").text("提示：正在删除，请稍候...");$.ajax({type:"POST",dataType:"text",data:{strIdList:e.filesId,strFidList:e.foldersId},url:"homeController/deleteCheckedFiles.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{if(e=="noAuthorized"){$("#deleteFileMessage").text("提示：您的操作未被授权，删除失败");$("#dfmbutton").attr("disabled",false)}else if(e=="errorParameter"){$("#deleteFileMessage").text("提示：参数不正确，未能全部删除文件");$("#dfmbutton").attr("disabled",false)}else if(e=="cannotDeleteFile"){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件");$("#dfmbutton").attr("disabled",false)}else if(e=="deleteFileSuccess"){$("#deleteFileModal").modal("hide");showFolderView(locationpath)}else{$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件");$("#dfmbutton").attr("disabled",false)}}},error:function(){$("#deleteFileMessage").text("提示：出现意外错误，可能未能删除全部文件");$("#dfmbutton").attr("disabled",false)}})}function playAudio(fileId){$("#audioPlayerModal").modal("show");if(pingInt==null){pingInt=setInterval("ping()",6e4)}if(ap==null){ap=new APlayer({container:document.getElementById("aplayer"),lrcType:3,mutex:true,volume:.7,theme:"#EDEDED",audio:[]});ap.on("pause",function(){$("#playOrPause").html("<span class='glyphicon glyphicon-play' aria-hidden='true'></span>")});ap.on("play",function(){$("#playOrPause").html("<span class='glyphicon glyphicon-pause' aria-hidden='true'></span>")})}ap.list.clear();$.ajax({url:"homeController/playAudios.ajax",data:{fileId:fileId},type:"POST",dataType:"text",success:function(result){var ail=eval("("+result+")");for(var i=0;i<ail.as.length;i++){ail.as[i].name=ail.as[i].name.replace("'","&#39;").replace("<","&lt;").replace(">","&gt;")}ap.list.add(ail.as);ap.list.switch(ail.index);audio_play()},error:function(){alert("错误：无法获取音乐列表，请稍后再试");closeAudioPlayer()}})}function closeAudioPlayer(){$("#audioPlayerModal").modal("hide")}function audio_playOrPause(){ap.toggle()}function audio_play(){ap.play()}function audio_pasue(){ap.pause()}function audio_fw(){ap.skipForward()}function audio_bw(){ap.skipBack()}function audio_vulome_up(){ap.volume(ap.audio.volume+.1,true)}function audio_vulome_down(){ap.volume(ap.audio.volume-.1,true)}function sortbyfn(){if(!loadingComplete){return}if($("#sortByCD,#sortByFS,#sortByCN,#sortByOR").hasClass("glyphicon glyphicon-hourglass")){return}$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();var e=1;if($("#sortByFN").hasClass("glyphicon-triangle-bottom")){e=-1}$("#sortByFN").removeClass();$("#sortByFN").addClass("glyphicon glyphicon-hourglass");setTimeout(function(){folderView.fileList.sort(function(t,o){return e*o.fileName.localeCompare(t.fileName,"zh")});folderView.folderList.sort(function(t,o){return e*o.folderName.localeCompare(t.folderName,"zh")});showFolderTable(folderView);$("#sortByFN").removeClass();if(e==-1){$("#sortByFN").addClass("glyphicon glyphicon-triangle-top")}else{$("#sortByFN").addClass("glyphicon glyphicon-triangle-bottom")}},0)}function sortbycd(){if(!loadingComplete){return}if($("#sortByFN,#sortByFS,#sortByCN,#sortByOR").hasClass("glyphicon glyphicon-hourglass")){return}$("#sortByFN").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();var e=1;if($("#sortByCD").hasClass("glyphicon-triangle-bottom")){e=-1}$("#sortByCD").removeClass();$("#sortByCD").addClass("glyphicon glyphicon-hourglass");setTimeout(function(){folderView.fileList.sort(function(t,o){var l=t.fileCreationDate.replace("年","-").replace("月","-").replace("日","");var a=o.fileCreationDate.replace("年","-").replace("月","-").replace("日","");var r=new Date(Date.parse(l)).getTime()-new Date(Date.parse(a)).getTime();return e*r});folderView.folderList.sort(function(t,o){var l=t.folderCreationDate.replace("年","-").replace("月","-").replace("日","");var a=o.folderCreationDate.replace("年","-").replace("月","-").replace("日","");var r=new Date(Date.parse(l)).getTime()-new Date(Date.parse(a)).getTime();return e*r});showFolderTable(folderView);$("#sortByCD").removeClass();if(e==-1){$("#sortByCD").addClass("glyphicon glyphicon-triangle-top")}else{$("#sortByCD").addClass("glyphicon glyphicon-triangle-bottom")}},0)}function sortbyfs(){if(!loadingComplete){return}if($("#sortByFN,#sortByCD,#sortByCN,#sortByOR").hasClass("glyphicon glyphicon-hourglass")){return}$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();var e=1;if($("#sortByFS").hasClass("glyphicon-triangle-bottom")){e=-1}$("#sortByFS").removeClass();$("#sortByFS").addClass("glyphicon glyphicon-hourglass");setTimeout(function(){folderView.fileList.sort(function(t,o){return e*(t.fileSize-o.fileSize)});showFolderTable(folderView);$("#sortByFS").removeClass();if(e==-1){$("#sortByFS").addClass("glyphicon glyphicon-triangle-top")}else{$("#sortByFS").addClass("glyphicon glyphicon-triangle-bottom")}},0)}function sortbycn(){if(!loadingComplete){return}if($("#sortByFN,#sortByCD,#sortByFS,#sortByOR").hasClass("glyphicon glyphicon-hourglass")){return}$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByOR").removeClass();var e=1;if($("#sortByCN").hasClass("glyphicon-triangle-bottom")){e=-1}$("#sortByCN").removeClass();$("#sortByCN").addClass("glyphicon glyphicon-hourglass");setTimeout(function(){folderView.fileList.sort(function(t,o){return e*o.fileCreator.localeCompare(t.fileCreator,"zh")});folderView.folderList.sort(function(t,o){return e*o.folderCreator.localeCompare(t.folderCreator,"zh")});showFolderTable(folderView);$("#sortByCN").removeClass();if(e==-1){$("#sortByCN").addClass("glyphicon glyphicon-triangle-top")}else{$("#sortByCN").addClass("glyphicon glyphicon-triangle-bottom")}},0)}function showOriginFolderView(){if(!loadingComplete){return}if($("#sortByFN,#sortByCD,#sortByFS,#sortByCN").hasClass("glyphicon glyphicon-hourglass")){return}$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").addClass("glyphicon glyphicon-hourglass");setTimeout(function(){if(screenedFoldrView!=null){folderView=$.extend(true,{},screenedFoldrView)}else{folderView=$.extend(true,{},originFolderView)}showFolderTable(folderView);$("#sortByOR").removeClass()},0)}function startMoveFile(){if($("#cutSignTx").hasClass("cuted")&&checkedMovefiles!==undefined){$("#moveFilesMessage").text("提示：确定将这"+checkedMovefiles.size+"项移动到当前位置么？");$("#moveFilesBox").html("<button id='dmvfbutton' type='button' class='btn btn-danger' onclick='doMoveFiles()'>全部移动</button>");$("#selectFileMoveModelAsAll").removeAttr("checked");$("#selectFileMoveModelAlert").hide();$("#moveFilesModal").modal("show")}else{checkedMovefiles=getCheckedFilesAndFolders();if(checkedMovefiles==undefined||checkedMovefiles.size==0){$("#moveFilesMessage").html(checkFilesTip);$("#selectFileMoveModelAsAll").removeAttr("checked");$("#selectFileMoveModelAlert").hide();$("#moveFilesModal").modal("show")}else{$("#cutSignTx").html("粘贴（"+checkedMovefiles.size+"）<span class='pull-right'><span class='glyphicon glyphicon-arrow-up' aria-hidden='true'></span>+V</span>");$("#cutSignTx").addClass("cuted")}}}var repeMap;var strMoveOptMap;var mRepeSize;function doMoveFiles(){$("#dmvfbutton").attr("disabled",true);$("#moveFilesMessage").text("提示：正在移动，请稍候...");$.ajax({type:"POST",dataType:"text",data:{strIdList:checkedMovefiles.filesId,strFidList:checkedMovefiles.foldersId,locationpath:locationpath},url:"homeController/confirmMoveFiles.ajax",success:function(result){if(result=="mustLogin"){window.location.href="prv/login.html"}else{switch(result){case"noAuthorized":$("#moveFilesMessage").text("提示：您的操作未被授权，移动失败");$("#dmvfbutton").attr("disabled",false);break;case"errorParameter":$("#moveFilesMessage").text("提示：参数不正确，未能全部移动文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false);break;case"cannotMoveFiles":$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false);break;case"filesTotalOutOfLimit":$("#moveFilesMessage").text("提示：该文件夹内存储的文件数量已达上限，无法移入更多文件");$("#dmvfbutton").attr("disabled",false);break;case"foldersTotalOutOfLimit":$("#moveFilesMessage").text("提示：该文件夹内存储的文件夹数量已达上限，无法移入更多文件夹");$("#dmvfbutton").attr("disabled",false);break;case"confirmMoveFiles":strMoveOptMap={};sendMoveFilesReq();break;default:if(result.startsWith("duplicationFileName:")){repeMap=eval("("+result.substring(20)+")");repeIndex=0;strMoveOptMap={};mRepeSize=repeMap.repeFolders.length+repeMap.repeNodes.length;if(repeMap.repeFolders.length>0){$("#mrepeFileName").text(repeMap.repeFolders[repeIndex].folderName)}else{$("#mrepeFileName").text(repeMap.repeNodes[repeIndex].fileName)}var authList=originFolderView.authList;if(checkAuth(authList,"D")){$("#movecoverbtn").show()}else{$("#movecoverbtn").hide()}$("#selectFileMoveModelAlert").show()}else if(result.startsWith("CANT_MOVE_TO_INSIDE:")){$("#moveFilesMessage").text("错误：不能将一个文件夹移动到其自身内部："+result.substring(20))}else{$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false)}break}}},error:function(){$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件");$("#dmvfbutton").attr("disabled",false)}})}function selectFileMoveModel(e){if($("#selectFileMoveModelAsAll").prop("checked")){while(repeIndex<mRepeSize){if(repeIndex<repeMap.repeFolders.length){strMoveOptMap[repeMap.repeFolders[repeIndex].folderId]=e}else{strMoveOptMap[repeMap.repeNodes[repeIndex-repeMap.repeFolders.length].fileId]=e}repeIndex++}$("#selectFileMoveModelAlert").hide();sendMoveFilesReq()}if(repeIndex<repeMap.repeFolders.length){strMoveOptMap[repeMap.repeFolders[repeIndex].folderId]=e}else{strMoveOptMap[repeMap.repeNodes[repeIndex-repeMap.repeFolders.length].fileId]=e}repeIndex++;if(repeIndex<mRepeSize){if(repeIndex<repeMap.repeFolders.length){$("#mrepeFileName").text(repeMap.repeFolders[repeIndex].folderName)}else{$("#mrepeFileName").text(repeMap.repeNodes[repeIndex-repeMap.repeFolders.length].fileName)}}else{$("#selectFileMoveModelAlert").hide();sendMoveFilesReq()}}function sendMoveFilesReq(){var e=JSON.stringify(strMoveOptMap);$.ajax({type:"POST",dataType:"text",data:{strIdList:checkedMovefiles.filesId,strFidList:checkedMovefiles.foldersId,strOptMap:e,locationpath:locationpath},url:"homeController/moveCheckedFiles.ajax",success:function(e){if(e=="mustLogin"){window.location.href="prv/login.html"}else{switch(e){case"noAuthorized":$("#moveFilesMessage").text("提示：您的操作未被授权，移动失败");$("#dmvfbutton").attr("disabled",false);break;case"errorParameter":$("#moveFilesMessage").text("提示：参数不正确，未能全部移动文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false);break;case"filesTotalOutOfLimit":$("#moveFilesMessage").text("提示：该文件夹内存储的文件数量已达上限，无法移入更多文件。");$("#dmvfbutton").attr("disabled",false);break;case"foldersTotalOutOfLimit":$("#moveFilesMessage").text("提示：该文件夹内存储的文件夹数量已达上限，无法移入更多文件夹。");$("#dmvfbutton").attr("disabled",false);break;case"cannotMoveFiles":$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false);break;case"moveFilesSuccess":$("#moveFilesModal").modal("hide");showFolderView(locationpath);break;default:$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件，请刷新后重试");$("#dmvfbutton").attr("disabled",false);break}}},error:function(){$("#moveFilesMessage").text("提示：出现意外错误，可能未能移动全部文件");$("#dmvfbutton").attr("disabled",false)}})}var screenedFoldrView;function doSearchFile(){var e=$("#sreachKeyWordIn").val();var t="exact";if($("#caseinsensitive").is(":checked")){t="insensitive"}if(e.length!=0){if($("#isall").is(":checked")){selectInCompletePath(e,t)}if(e.startsWith("all:")||e.startsWith("all：")){selectInCompletePath(e.substring(4),t)}else{startLoading();selectInThisPath(e,t);endLoading()}}else{if(folderView.keyWorld!=null){showFolderView(locationpath)}else{screenedFoldrView=null;showOriginFolderView()}}}function selectInThisPath(e,t){try{var o=new RegExp(e+"+");screenedFoldrView=$.extend(true,{},originFolderView);screenedFoldrView.folderList=[];screenedFoldrView.fileList=[];if(t=="insensitive"){o=new RegExp(e.toLowerCase()+"+");for(var l=0,a=originFolderView.folderList.length;l<a;l++){if(o.test(originFolderView.folderList[l].folderName.toLowerCase())){screenedFoldrView.folderList.push(originFolderView.folderList[l])}}for(var l=0,a=originFolderView.fileList.length;l<a;l++){if(o.test(originFolderView.fileList[l].fileName.toLowerCase())){screenedFoldrView.fileList.push(originFolderView.fileList[l])}}}else{for(var l=0,a=originFolderView.folderList.length;l<a;l++){if(o.test(originFolderView.folderList[l].folderName)){screenedFoldrView.folderList.push(originFolderView.folderList[l])}}for(var l=0,a=originFolderView.fileList.length;l<a;l++){if(o.test(originFolderView.fileList[l].fileName)){screenedFoldrView.fileList.push(originFolderView.fileList[l])}}}$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();folderView=$.extend(true,{},screenedFoldrView);showFolderTable(folderView)}catch(e){alert("错误：搜索关键字有误。请在特殊符号（例如“*”）前加上“\\”进行转义。")}}function selectInCompletePath(keyworld,type){if(keyworld.length==0){showFolderView(locationpath);return}if(type.length==0){type="exact"}startLoading();$.ajax({type:"POST",dataType:"text",data:{fid:locationpath,keyworld:keyworld,type:type},url:"homeController/sreachInCompletePath.ajax",success:function(result){endLoading();if(result=="ERROR"){doAlert();$("#tb").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#publishTime").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#parentlistbox").html("<span class='graytext'>获取失败，请尝试刷新</span>")}else if(result=="mustLogin"){window.location.href="prv/login.html"}else if(result=="notAccess"){document.cookie="folder_id="+escape("root");window.location.href="/"}else{folderView=eval("("+result+")");locationpath=folderView.folder.folderId;parentpath=folderView.folder.folderParent;constraintLevel=folderView.folder.folderConstraint;screenedFoldrView=null;$("#sreachKeyWordIn").val(folderView.keyWorld);showParentList(folderView);showAccountView(folderView);showPublishTime(folderView);originFolderView=$.extend(true,{},folderView);$("#sortByFN").removeClass();$("#sortByCD").removeClass();$("#sortByFS").removeClass();$("#sortByCN").removeClass();$("#sortByOR").removeClass();showFolderTable(folderView)}},error:function(){endLoading();doAlert();$("#tb").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#publishTime").html("<span class='graytext'>获取失败，请尝试刷新</span>");$("#parentlistbox").html("<span class='graytext'>获取失败，请尝试刷新</span>")}})}function goBackToTop(){$("html,body").animate({scrollTop:0},"slow")}var getDownloadFileId;var getDownloadFileName;function getDownloadURL(){$.ajax({url:"externalLinksController/getDownloadKey.ajax",type:"POST",dataType:"text",data:{fId:getDownloadFileId},success:function(e){var t=window.location.protocol+"//"+window.location.host+"/externalLinksController/downloadFileByKey/"+encodeURIComponent(getDownloadFileName.replace(/\'/g,""))+"?dkey="+e;$("#downloadHrefBox").html("<a href='"+t+"'>"+t+"</a>")},error:function(){$("#downloadHrefBox").html("<span class='text-muted'>获取失败，请检查网络状态或<a href='javascript:void(0);' onclick='getDownloadURL()'>点此</a>重新获取。</span>")}})}function ping(){$.ajax({url:"homeController/ping.ajax",type:"POST",dataType:"text",data:{},success:function(e){if(e!="pong"){if(pingInt!=null){window.clearInterval(pingInt);pingInt=null}}},error:function(){if(pingInt!=null){window.clearInterval(pingInt);pingInt=null}}})}function isSupportWebkitdirectory(){var e=document.createElement("input");if("webkitdirectory"in e&&!/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)){return true}else{return false}}function showUploadFolderModel(){$("#importFolderAlert").hide();$("#importFolderAlert").text("");if(isImporting==false){$("#folderpath").val("");$("#importfolder").val("");$("#importpros").width("0%");$("#importpros").attr("aria-valuenow","0");$("#importstatus").html("");$("#folderpath").attr("disabled",false);$("#importFolderLevelBtn").attr("disabled",false);$("#importcount").text("");$("#importbutton").attr("disabled",false);$("#importfoldertypelist").html("");$("#selectFolderImportModelAlert").hide();if(account!=null){$("#folderpath").attr("folderConstraintLevel",constraintLevel+"");$("#importfoldertype").text(folderTypes[constraintLevel]);for(var e=constraintLevel;e<folderTypes.length;e++){$("#importfoldertypelist").append("<li><a onclick='changeImportFolderType("+e+")'>"+folderTypes[e]+"</a></li>")}}else{$("#importfoldertypelist").append("<li><a onclick='changeImportFolderType(0)'>"+folderTypes[0]+"</a></li>")}}$("#importFolderModal").modal("show")}function checkimportpath(){$("#importfolder").click()}function getInputImport(){ifs=$("#importfolder")[0].files;if(ifs.length>0){importFolderName=ifs[0].webkitRelativePath.substring(0,ifs[0].webkitRelativePath.indexOf("/"));$("#folderpath").val(importFolderName)}}function checkImportFolder(){if(isUpLoading==false&&isImporting==false){if(ifs!=null&&ifs.length>0){$("#folderpath").attr("disabled",true);$("#importFolderLevelBtn").attr("disabled",true);$("#importbutton").attr("disabled",true);$("#importFolderAlert").hide();$("#importFolderAlert").text("");isImporting=true;var maxSize=0;var maxFileIndex=0;for(var i=0;i<ifs.length;i++){if(ifs[i].size>maxSize){maxSize=ifs[i].size;maxFileIndex=i}}$.ajax({url:"homeController/checkImportFolder.ajax",type:"POST",dataType:"text",data:{folderName:importFolderName,maxSize:maxSize,folderId:locationpath},success:function(result){var resJson=eval("("+result+")");switch(resJson.result){case"noAuthorized":showImportFolderAlert("提示：您的操作未被授权，无法开始上传");break;case"errorParameter":showImportFolderAlert("提示：参数不正确，无法开始上传");break;case"mustLogin":window.location.href="prv/login.html";break;case"fileOverSize":showImportFolderAlert("提示：文件["+ifs[maxFileIndex].webkitRelativePath+"]的体积超过最大限制（"+resJson.maxSize+"），无法开始上传");break;case"foldersTotalOutOfLimit":showImportFolderAlert("提示：该文件夹内存储的文件夹数量已达上限，无法在其中上传更多文件夹。您可以尝试将其上传至其他文件夹内。");break;case"repeatFolder_Both":$("#repeFolderName").text(importFolderName);$("#importcoverbtn").hide();$("#selectFolderImportModelAlert").show();break;case"repeatFolder_coverOrBoth":$("#repeFolderName").text(importFolderName);$("#importcoverbtn").show();$("#selectFolderImportModelAlert").show();break;case"permitUpload":iteratorImport(0);break;default:showImportFolderAlert("提示：出现意外错误，无法开始上传");break}},error:function(){showImportFolderAlert("提示：出现意外错误，无法开始上传")}})}else{showImportFolderAlert("提示：您未选择任何文件夹，无法开始上传")}}else{showImportFolderAlert("提示：另一项上传文件或文件夹的任务尚未完成，无法开始上传")}}function showImportFolderAlert(e){isImporting=false;$("#folderpath").attr("disabled",false);$("#importFolderLevelBtn").attr("disabled",false);$("#importFolderAlert").show();$("#importFolderAlert").text(e);$("#importbutton").attr("disabled",false)}function importProgress(e){if(e.lengthComputable){var t=Math.round(e.loaded*100/e.total);$("#importpros").width(t+"%");$("#importpros").attr("aria-valuenow",""+t)}}function importAndCover(){$("#selectFolderImportModelAlert").hide();$.ajax({url:"homeController/deleteFolderByName.ajax",type:"POST",data:{parentId:locationpath,folderName:importFolderName},dataType:"text",success:function(e){if(e=="deleteSuccess"){iteratorImport(0)}else{showImportFolderAlert("提示：无法覆盖原文件夹，上传失败")}},error:function(){showImportFolderAlert("提示：无法覆盖原文件夹，上传失败")}})}function importAndBoth(){$("#selectFolderImportModelAlert").hide();var fc=$("#folderpath").attr("folderConstraintLevel");$.ajax({url:"homeController/createNewFolderByName.ajax",type:"POST",data:{parentId:locationpath,folderName:importFolderName,folderConstraint:fc},dataType:"text",success:function(result){var resJson=eval("("+result+")");if(resJson.result=="success"){iteratorImport(0,resJson.newName)}else if(resJson.result=="foldersTotalOutOfLimit"){showImportFolderAlert("提示：该文件夹内存储的文件夹数量已达上限，无法上传同名文件夹并保留两者。您可以尝试将其上传至其他文件夹内。")}else{showImportFolderAlert("提示：生成新文件夹名称失败，无法开始上传")}},error:function(){showImportFolderAlert("提示：生成新文件夹名称失败，无法开始上传")}})}function iteratorImport(e,t){$("#importpros").width("0%");$("#importpros").attr("aria-valuenow","0");var o=ifs[e];var l=ifs.length;var a=$("#folderpath").attr("folderConstraintLevel");if(o!=null){var r=o.webkitRelativePath;if(l>1){$("#importcount").text("（"+(e+1)+"/"+l+"）")}$("#importstatus").prepend("<p>"+r+"<span id='ils_"+e+"'>[正在上传...]</span></p>");xhr=new XMLHttpRequest;var i=new FormData;i.append("file",o);i.append("folderId",locationpath);i.append("folderConstraint",a);if(!!t){i.append("newFolderName",t)}xhr.open("POST","homeController/doImportFolder.ajax",true);xhr.upload.addEventListener("progress",importProgress,false);xhr.send(i);if(pingInt==null){pingInt=setInterval("ping()",6e4)}xhr.onloadend=function(){if(pingInt!=null){window.clearInterval(pingInt);pingInt=null}if(xhr.status===200){var o=xhr.responseText;if(o=="uploadsuccess"){$("#ils_"+e).text("[已完成]");var a=e+1;if(a<l){iteratorImport(a,t)}else{isImporting=false;$("#folderpath").removeAttr("disabled");$("#importFolderLevelBtn").removeAttr("disabled");$("#importfolder").val("");$("#folderpath").val("");$("#importpros").width("0%");$("#importpros").attr("aria-valuenow","0");$("#importbutton").attr("disabled",false);$("#importcount").text("");$("#importstatus").text("");$("#importFolderModal").modal("hide");showFolderView(locationpath)}}else if(o=="uploaderror"){showImportFolderAlert("提示：出现意外错误，文件：["+r+"]上传失败，上传被中断。");$("#ils_"+e).text("[失败]")}else if(o=="foldersTotalOutOfLimit"){showImportFolderAlert("提示：该文件夹内存储的文件夹数量已达上限，文件：["+r+"]上传失败，上传被中断。");$("#ils_"+e).text("[失败]")}else if(o=="filesTotalOutOfLimit"){showImportFolderAlert("提示：该文件夹内存储的文件数量已达上限，文件：["+r+"]上传失败，上传被中断。");$("#ils_"+e).text("[失败]")}else{showImportFolderAlert("提示：出现意外错误，文件：["+r+"]上传失败，上传被中断。");$("#ils_"+e).text("[失败]")}}else{showImportFolderAlert("提示：出现意外错误，文件：["+r+"]上传失败，上传被中断。");$("#ils_"+e).text("[失败]")}}}else{showImportFolderAlert("提示：要上传的文件不存在。");$("#importstatus").prepend("<p>未找到要上传的文件<span id='ils_"+e+"'>[失败]</span></p>")}}function abortImport(){isImporting=false;if(xhr!=null){xhr.abort()}$("#importFolderModal").modal("hide");showFolderView(locationpath)}function changeImportFolderType(e){$("#importfoldertype").text(folderTypes[e]);$("#folderpath").attr("folderConstraintLevel",e+"")}function doChangePassword(){$("#changepassword_oldepwdbox,#changepassword_newpwdbox,#changepassword_reqnewpwdbox").removeClass("has-error");$("#changepasswordalertbox").hide();var change_oldPassword=$("#changepassword_oldpwd").val();var change_newPassword=$("#changepassword_newpwd").val();var change_reqNewPassword=$("#changepassword_reqnewpwd").val();if(change_oldPassword.length==0){$("#changepassword_oldepwdbox").addClass("has-error");$("#changepassword_oldpwd").focus();return}if(change_newPassword.length==0){$("#changepassword_newpwdbox").addClass("has-error");$("#changepassword_newpwd").focus();return}if(change_reqNewPassword.length==0){$("#changepassword_reqnewpwdbox").addClass("has-error");$("#changepassword_reqnewpwd").focus();return}isChangingPassword=true;$("#changepassword_oldpwd,#changepassword_newpwd,#changepassword_reqnewpwd,#changePasswordButton,#changepassword_vercode").attr("disabled",true);if(change_newPassword+""!=change_reqNewPassword+""){showChangePasswordAlert("提示：两次输入的新密码不一致，请检查确认");$("#changepassword_newpwdbox").addClass("has-error");$("#changepassword_reqnewpwdbox").addClass("has-error");return}$.ajax({url:"homeController/getPublicKey.ajax",type:"POST",data:{},dataType:"text",success:function(result){var changepwd_publicKeyInfo=eval("("+result+")");var changePasswordInfo='{oldPwd:"'+change_oldPassword+'",newPwd:"'+change_newPassword+'",time:"'+changepwd_publicKeyInfo.time+'"}';var encrypt=new JSEncrypt;encrypt.setPublicKey(changepwd_publicKeyInfo.publicKey);var encrypted=encrypt.encrypt(changePasswordInfo);sendChangePasswordInfo(encrypted)},error:function(){showChangePasswordAlert("提示：密码修改失败，请检查网络链接或服务器运行状态")}})}function sendChangePasswordInfo(e){$.ajax({type:"POST",dataType:"text",url:"homeController/doChangePassword.ajax",data:{encrypted:e,vercode:$("#changepassword_vercode").val()},success:function(e){$("#changepassword_vccodebox").hide();isChangingPassword=false;switch(e){case"success":$("#changePasswordModal").modal("hide");break;case"mustlogin":showChangePasswordAlert("提示：登录已失效或尚未登录账户，请刷新并登陆账户");break;case"illegal":showChangePasswordAlert("提示：用户修改密码功能已被禁用，请求被拒绝");break;case"oldpwderror":showChangePasswordAlert("提示：旧密码输入错误，请求被拒绝");$("#changepassword_oldepwdbox").addClass("has-error");break;case"needsubmitvercode":$("#changepassword_oldpwd,#changepassword_newpwd,#changepassword_reqnewpwd,#changePasswordButton").attr("disabled",false);$("#changepassword_vccodebox").html("<label id='changepassword_vercodetitle' class='col-sm-5'><img id='changepassword_showvercode' class='vercodeimg' alt='点击获取验证码' src='homeController/getNewVerCode.do?s="+(new Date).getTime()+"' onclick='changePasswordGetNewVerCode()'></label><div class='col-sm-7'><input type='text' class='form-control' id='changepassword_vercode' placeholder='验证码……'></div>");$("#changepassword_vccodebox").show();isChangingPassword=false;break;case"invalidnewpwd":showChangePasswordAlert("提示：密码修改失败，新密码不合法。新密码的长度需为3-32个字符，且仅支持ISO-8859-1中的字符（推荐使用英文字母、英文符号及阿拉伯数字）。");break;case"error":showChangePasswordAlert("提示：密码修改失败，修改请求无法通过加密效验（可能是请求耗时过长导致的）");break;case"cannotchangepwd":showChangePasswordAlert("提示：密码修改失败，发生意外错误，请稍后重试或联系管理员");break;default:showChangePasswordAlert("提示：密码修改失败，发生未知错误");break}},error:function(){showChangePasswordAlert("提示：密码修改失败，请检查网络链接或服务器运行状态")}})}function showChangePasswordAlert(e){isChangingPassword=false;$("#changepassword_oldpwd,#changepassword_newpwd,#changepassword_reqnewpwd,#changePasswordButton,#changepassword_vercode").attr("disabled",false);$("#changepasswordalertbox").show();$("#changepasswordalertbox").text(e)}function changePasswordGetNewVerCode(){$("#changepassword_showvercode").attr("src","homeController/getNewVerCode.do?s="+(new Date).getTime())}function getFileChain(e,t){$("#fileChainTextarea").text("正在获取……");$("#copyChainBtn").attr("disabled",true);$("#fileChainModal").modal("show");$.ajax({type:"POST",dataType:"text",url:"homeController/getFileChainKey.ajax",data:{fid:e},success:function(e){switch(e){case"ERROR":$("#fileChainTextarea").text("提示：获取失败，请刷新页面或稍后再试。");break;case"mustlogin":window.location.href="prv/login.html";break;default:var o=t.replace("#","%23").replace("%","%25").replace("?","%3F");$("#fileChainTextarea").text(encodeURI(window.location.protocol+"//"+window.location.host+"/externalLinksController/chain/"+o+"?ckey=")+encodeURIComponent(e));$("#copyChainBtn").attr("disabled",false);break}},error:function(){$("#fileChainTextarea").text("提示：获取失败，无法连接服务器。")}})}function copyFileChain(){let e=document.getElementById("fileChainTextarea");let t=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent);if(t){e.setSelectionRange(0,9999)}else{const t=document.createRange();t.selectNode(e);const o=window.getSelection();if(o.rangeCount>0)o.removeAllRanges();o.addRange(t)}document.execCommand("copy")}function showNoticeModal(){$("#noticeModal").modal("show")}function initNoticeModal(){$("#noticeModalBody").load("resourceController/getNoticeContext.do",function(){$("#noticeModalBody img").css("max-width","100%");if(winHeight>=300){$("#noticeModalBody").css("max-height",winHeight-180+"px")}else{$("#noticeModalBody").css("max-height","300px")}noticeInited=true;showNoticeModal();showNoticeBtn()})}function subscribeNotice(){$.ajax({url:"resourceController/getNoticeMD5.ajax",data:{},type:"POST",dataType:"text",success:function(e){if(e!=""){var t=document.cookie.match(new RegExp("(^| )notice_md5=([^;]*)(;|$)"));if(t){if(e==unescape(t[2])){showNoticeBtn();return}}else{t=document.cookie.match(new RegExp("(^| )notice_md5_30=([^;]*)(;|$)"));if(t){if(e==unescape(t[2])){showNoticeBtn();return}}}initNoticeModal();document.cookie="notice_md5="+escape(e)}},error:function(){alert("错误：无法从服务器获取公告信息，请尝试刷新页面。")}})}function showNoticeBtn(){$("#shownoticebox").removeClass("hidden");$("#shownoticebox").addClass("show")}function showNotice(){if(noticeInited){showNoticeModal()}else{initNoticeModal()}}function loadingRemainingFolderView(targetId){if(remainingLoadingRequest){return}var newfoldersOffset=0;var newfilesOffset=0;if(folderView.foldersOffset-folderView.selectStep>0){newfoldersOffset=folderView.foldersOffset-folderView.selectStep}if(folderView.filesOffset-folderView.selectStep>0){newfilesOffset=folderView.filesOffset-folderView.selectStep}if(newfoldersOffset<=0&&newfilesOffset<=0){originFolderView=$.extend(true,{},folderView);hiddenLoadingRemaininngBox();doFixedRow(targetId);return}var loadingRemainingRate_folders=1;var loadingRemainingRate_files=1;if(totalFoldersOffset>0){loadingRemainingRate_folders=(totalFoldersOffset-newfoldersOffset)/totalFoldersOffset}if(totalFilesOffset>0){loadingRemainingRate_files=(totalFilesOffset-newfilesOffset)/totalFilesOffset}var loadingRemainingRate=(loadingRemainingRate_folders+loadingRemainingRate_files)/2;$("#loadingrate").text(parseInt(loadingRemainingRate*100)+"%");remainingLoadingRequest=$.ajax({url:"homeController/getRemainingFolderView.ajax",data:{fid:locationpath,foldersOffset:newfoldersOffset,filesOffset:newfilesOffset},type:"POST",dataType:"text",success:function(result){remainingLoadingRequest=null;switch(result){case"ERROR":alert("错误：无法加载剩余文件列表，文件数据可能未显示完全，请刷新重试！");hiddenLoadingRemaininngBox();doFixedRow();break;case"NOT_FOUND":case"notAccess":document.cookie="folder_id="+escape("root");case"mustLogin":window.location.href="/";break;default:folderView.foldersOffset=newfoldersOffset;folderView.filesOffset=newfilesOffset;var remainingFV=eval("("+result+")");updateFolderTable(remainingFV);updateTheFolderInfo();if(folderView.foldersOffset>0||folderView.filesOffset>0){loadingRemainingFolderView(targetId)}else{originFolderView=$.extend(true,{},folderView);hiddenLoadingRemaininngBox();doFixedRow(targetId)}break}},error:function(e,t,o){remainingLoadingRequest=null;hiddenLoadingRemaininngBox();if("abort"!=t){alert("错误：无法连接服务器，文件列表加载被中断。请刷新重试！")}}})}function doFixedRow(e){if(e&&e.length>0){$("#"+e).addClass("info");$("html,body").animate({scrollTop:$("#"+e).offset().top-$(window).height()/2},"slow")}}function showLoadingRemaininngBox(){loadingComplete=false;$("#loadingremaininngbox").addClass("show");$("#loadingremaininngbox").removeClass("hidden");$("#searchbtn").attr("disabled","disabled")}function hiddenLoadingRemaininngBox(){loadingComplete=true;$("#loadingremaininngbox").removeClass("show");$("#loadingremaininngbox").addClass("hidden");$("#searchbtn").removeAttr("disabled")}function updateFolderTable(e){var t=folderView.authList;var o=false;var l=false;var a=false;var r=false;if(checkAuth(t,"D")){o=true}if(checkAuth(t,"R")){l=true}if(checkAuth(t,"L")){a=true}if(checkAuth(t,"O")){r=true}if(e.folderList){if(e.folderList.length>0){for(var i=e.folderList.length;i>0;i--){var s=e.folderList[i-1];if(!folderContains(folderView.folderList,s.folderId)){folderView.folderList.unshift(s);$("[iskfolder=true]:last").after(createNewFolderRow(s,o,l,r))}}}}if(e.fileList){if(e.fileList.length>0){for(var n=e.fileList.length;n>0;n--){var d=e.fileList[n-1];if(!fileContains(folderView.fileList,d.fileId)){folderView.fileList.unshift(d);$("#foldertable").append(createFileRow(d,a,o,l,r))}}}}}function folderContains(e,t){for(var o=e.length;o>0;o--){if(e[o-1].folderId==t){return true}}return false}function fileContains(e,t){for(var o=e.length;o>0;o--){if(e[o-1].fileId==t){return true}}return false}function updateTheFolderInfo(){$("#fim_statistics").text("共包含 "+folderView.folderList.length+" 个文件夹， "+folderView.fileList.length+" 个文件。")}